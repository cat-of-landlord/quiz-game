<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¸–ç•Œå›½å®¶å¡«å›¾æŒ‘æˆ˜ | åœ°ç†é—®ç­”</title>
    <style>
      /* å…¨å±€æ ·å¼é‡ç½® */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Microsoft YaHei", Arial, sans-serif;
      }

      body {
        background-color: #f5f7fa;
        color: #333;
        line-height: 1.6;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* å¤´éƒ¨æ ·å¼ */
      header {
        background: linear-gradient(135deg, #2c3e50, #34495e);
        color: white;
        padding: 1.5rem 2rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        position: relative;
      }

      .back-btn {
        position: absolute;
        left: 2rem;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 0.5rem 1.2rem;
        border-radius: 20px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
      }

      .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-50%) scale(1.05);
      }

      .stats-bar {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-top: 1rem;
        flex-wrap: wrap;
      }

      .stat-item {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1.2rem;
        border-radius: 20px;
        font-size: 1rem;
      }

      .stat-number {
        font-weight: bold;
        color: #3498db;
        font-size: 1.2rem;
      }

      /* ä¸»å®¹å™¨ */
      .main-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
        padding: 2rem 1rem;
      }

      /* åœ°å›¾å’Œåˆ—è¡¨å®¹å™¨ */
      .content-wrapper {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
        flex: 1;
      }

      @media (max-width: 992px) {
        .content-wrapper {
          grid-template-columns: 1fr;
        }
      }

      /* åœ°å›¾åŒºåŸŸ */
      .map-section {
        background: white;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: hidden;
        height: 600px;
      }

      .map-tip {
        padding: 0.8rem 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 0.8rem;
        font-size: 0.9rem;
        color: #555;
        line-height: 1.5;
        border-left: 3px solid #3498db;
      }

      .map-wrapper {
        width: 100%;
        height: calc(100% - 50px);
        position: relative;
        overflow: hidden;
        cursor: pointer;
      }

      #world-svg {
        width: 100%;
        height: 100%;
        min-width: 800px;
        min-height: 600px;
        transition: transform 0.3s ease;
      }

      /* åŒºåŸŸåˆ—è¡¨åŒºåŸŸ */
      .region-list {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        max-height: 600px;
        overflow-y: auto;
      }

      .continent-group {
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 1rem;
      }

      .continent-name {
        font-size: 1.1rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 0.8rem;
      }

      .subregion-group {
        margin-bottom: 1rem;
        padding-left: 0.5rem;
      }

      .subregion-name {
        font-size: 1rem;
        color: #34495e;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
      }

      .subregion-progress {
        font-size: 0.9rem;
        color: #7f8c8d;
      }

      .country-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .country-tag {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.9rem;
        background: #ecf0f1;
        color: #7f8c8d;
        transition: all 0.3s;
        display: none;
      }

      .country-tag.filled {
        display: inline-block;
        background: #2ecc71;
        color: white;
      }

      .country-tag.unfilled {
        display: inline-block;
        background: #e74c3c;
        color: white;
      }

      /* è¾“å…¥æ åŒºåŸŸ */
      .input-section-container {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 1.5rem 2rem;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        border-top: 1px solid #e0e0e0;
        z-index: 1000;
        margin-top: auto;
        transition: all 0.3s ease;
      }

      .input-section {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .input-wrapper {
        flex: 1;
        min-width: 300px;
        position: relative;
      }

      #country-input {
        width: 100%;
        padding: 0.8rem 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.3s;
      }

      #country-input:focus {
        border-color: #3498db;
      }

      /* æŒ‰é’®æ ·å¼ */
      .button-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
      }

      .btn-submit {
        background: #3498db;
        color: white;
      }

      .btn-submit:hover {
        background: #2980b9;
      }

      .btn-end {
        background: #9b59b6;
        color: white;
      }

      .btn-end:hover {
        background: #8e44ad;
      }

      .btn-reset {
        background: #e74c3c;
        color: white;
      }

      .btn-reset:hover {
        background: #c0392b;
      }

      /* æç¤ºæ¶ˆæ¯ */
      .message {
        width: 100%;
        margin-top: 1rem;
        padding: 0.8rem;
        border-radius: 8px;
        font-weight: bold;
        display: none;
      }

      .success {
        background: #d5f5e3;
        color: #27ae60;
        display: block;
      }

      .error {
        background: #fadbd8;
        color: #e74c3c;
        display: block;
      }

      /* ç»“æœå¼¹çª— */
      .result-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }

      .result-content {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        max-width: 800px;
        width: 95%;
        max-height: 90vh;
        overflow-y: auto;
        text-align: center;
      }

      .result-title {
        font-size: 1.5rem;
        color: #2c3e50;
        margin-bottom: 1.5rem;
      }

      .result-stats {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .result-stat {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #eee;
      }

      .result-label {
        color: #7f8c8d;
      }

      .result-value {
        font-weight: bold;
        color: #2c3e50;
      }

      .result-accuracy {
        font-size: 1.2rem;
        color: #e74c3c;
      }

      /* é‡ç½®æŒ‰é’® */
      .reset-section {
        text-align: center;
        margin-top: 2rem;
        flex-shrink: 0;
      }

      /* å›½å®¶åç§°æç¤ºæ¡† - ä¿®æ”¹ä¸ºbodyä¸‹ï¼Œç¡®ä¿å±‚çº§æœ€é«˜ */
      .country-tooltip {
        position: fixed;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 0.6rem 1rem;
        border-radius: 6px;
        font-size: 0.9rem;
        pointer-events: none;
        z-index: 999999;
        opacity: 0;
        transition: opacity 0.15s ease;
        white-space: nowrap;
      }

      /* å“åº”å¼é€‚é… */
      @media (max-width: 768px) {
        .main-container {
          padding: 1rem;
        }

        .content-wrapper {
          gap: 1rem;
        }

        .map-section,
        .region-list {
          max-height: 500px;
        }

        .input-section {
          flex-direction: column;
        }

        .input-wrapper {
          min-width: 100%;
        }

        .button-group {
          width: 100%;
        }

        .btn {
          flex: 1;
          text-align: center;
        }

        .stats-bar {
          gap: 1rem;
        }

        .stat-item {
          padding: 0.3rem 0.8rem;
          font-size: 0.9rem;
        }

        .back-btn {
          padding: 0.3rem 0.8rem;
          font-size: 0.9rem;
          left: 1rem;
        }

        .map-tip {
          font-size: 0.8rem;
          padding: 0.6rem 0.8rem;
        }

        .map-wrapper {
          height: calc(100% - 45px);
        }
      }

      @media (max-width: 576px) {
        .map-section {
          height: 400px;
        }

        .region-list {
          max-height: 400px;
        }

        .button-group {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }

      /* æ­£ç¡®ç‡ç»Ÿè®¡åŒºåŸŸæ ·å¼ */
      .final-stats {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .stat-detail {
        font-size: 0.9rem;
        color: #666;
        margin-top: 5px;
        line-height: 1.4;
      }
      .highlight-val {
        color: #2c3e50;
        font-weight: bold;
      }

      .city-stats-list {
        margin-top: 20px;
        border-top: 1px solid #eee;
        padding-top: 15px;
      }
      .city-stat-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
      }
      .bar-container {
        flex: 1;
        height: 8px;
        background-color: #f0f0f0;
        border-radius: 4px;
        overflow: hidden;
      }
      .bar-fill {
        height: 100%;
        background-color: #ff4444;
        transition: width 0.3s ease;
      }
      .bar-fill.correct {
        background-color: #4caf50;
      }
    </style>
  </head>
  <body>
    <!-- å¤´éƒ¨ï¼šæ ‡é¢˜å’Œç»Ÿè®¡ - æ–°å¢è¿”å›æŒ‰é’® -->
    <header>
      <a href="index.html" class="back-btn">â† è¿”å›é¦–é¡µ</a>
      <h1>ä¸–ç•Œå›½å®¶å¡«å›¾æŒ‘æˆ˜</h1>
      <div class="stats-bar">
        <button
          id="view-result-btn"
          class="btn btn-submit"
          style="display: none; margin-left: 1rem"
        >
          æŸ¥çœ‹ç»“æœ
        </button>

        <div class="stat-item">
          å·²å¡«/æ€»æ•°ï¼š<span id="filled-count" class="stat-number">0</span>/<span
            id="total-count"
            class="stat-number"
            >0</span
          >
        </div>
        <div class="stat-item">
          ç”¨æ—¶ï¼š<span id="timer" class="stat-number">00:00</span>
        </div>
      </div>
    </header>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-container">
      <!-- åœ°å›¾å’ŒåŒºåŸŸåˆ—è¡¨ -->
      <div class="content-wrapper">
        <!-- åœ°å›¾åŒºåŸŸ -->
        <div class="map-section">
          <!-- åœ°å›¾ä½¿ç”¨æç¤ºå£°æ˜ -->
          <div class="map-tip">
            ğŸŒ
            å¡«å†™è§„åˆ™ï¼š1.å¯ä»¥è¾“å…¥å›½å®¶çš„ä¸­æ–‡åæˆ–è‹±æ–‡åï¼›2.æ”¯æŒç®€å†™ï¼ˆå¦‚ï¼šç¾å›½ã€UKç­‰ï¼‰ï¼›3.åœ°å›¾å•å‡»ä»»æ„ä½ç½®æ”¾å¤§ï¼ˆä»¥ç‚¹å‡»ä½ç½®ä¸ºä¸­å¿ƒï¼‰ï¼Œå†æ¬¡å•å‡»å¤åŸï¼›4.é¼ æ ‡æ‚¬æµ®å¯ä»¥æ˜¾ç¤ºå·²ç­”å‡ºå›½å®¶å
          </div>
          <div class="map-wrapper" id="map-wrapper">
            <object
              id="world-svg"
              data="ä¸–ç•Œå›½å®¶/ä¸–ç•Œåœ°å›¾.svg"
              type="image/svg+xml"
            ></object>
          </div>
        </div>

        <!-- åŒºåŸŸåˆ—è¡¨åŒºåŸŸ -->
        <div class="region-list" id="region-list"></div>
      </div>

      <!-- é‡ç½®æŒ‰é’® -->
      <div class="reset-section">
        <button id="reset-btn" class="btn btn-reset">é‡æ–°å¼€å§‹æŒ‘æˆ˜</button>
      </div>
    </div>

    <!-- è¾“å…¥æ ï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼‰ -->
    <div class="input-section-container">
      <div class="input-section">
        <div class="input-wrapper">
          <input
            type="text"
            id="country-input"
            placeholder="è¾“å…¥å›½å®¶åç§°ï¼ˆæ”¯æŒä¸­æ–‡åã€è‹±æ–‡åæˆ–ç®€å†™ï¼‰"
            autocomplete="off"
          />
        </div>
        <div class="button-group">
          <button id="submit-btn" class="btn btn-submit">æäº¤ç­”æ¡ˆ</button>
          <button id="end-btn" class="btn btn-end">ç»“æŸæŒ‘æˆ˜</button>
        </div>
        <div class="message" id="message"></div>
      </div>
    </div>

    <!-- ç»“æœå¼¹çª— -->
    <div class="result-modal" id="result-modal">
      <div class="result-content">
        <h2 class="result-title">æŒ‘æˆ˜ç»“æŸï¼</h2>
        <div id="final-stats" class="final-stats"></div>
        <div class="result-stats" id="result-stats"></div>
        <button id="close-result-btn" class="btn btn-reset">å…³é—­</button>
        <div class="city-stats-list" id="city-stats-list">
          <h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: #2c3e50">
            å›½å®¶è¯†åˆ«æƒ…å†µï¼ˆç»¿è‰²ä¸ºæ‚¨ç­”å¯¹ï¼‰
          </h3>
        </div>
      </div>
    </div>

    <!-- å›½å®¶åç§°æç¤ºæ¡† - ç§»åˆ°bodyä¸‹ç¡®ä¿å±‚çº§æœ€é«˜ -->
    <div class="country-tooltip" id="country-tooltip"></div>

    <script>
      // æ ¸å¿ƒæ•°æ®å­˜å‚¨
      let countryData = [];
      let allCountries = [];
      let countryInfoMap = {}; // ç”¨äºå­˜å‚¨countries.jsonä¸­çš„è¯¦ç»†ä¿¡æ¯
      let filledCountries = new Set();
      let totalAttempts = 0;
      let correctAttempts = 0;
      let timerInterval = null;
      let startTime = 0;
      let isGameEnded = false;

      // åœ°å›¾ç¼©æ”¾ç›¸å…³å˜é‡
      let isZoomed = false;
      let scale = 1;
      let translateX = 0;
      let translateY = 0;

      // æç¤ºæ¡†å…ƒç´  - ç°åœ¨åœ¨bodyä¸‹
      const tooltip = document.getElementById("country-tooltip");

      // å­˜å‚¨å›½å®¶åŸå§‹é¢œè‰²
      let originalColors = new Map();

      // ç®€å†™æ˜ å°„è¡¨
      const shortNameMap = {
        // ä¸­æ–‡ç®€å†™
        ç¾å›½: "United States of America",
        è‹±å›½: "United Kingdom",
        æ³•å›½: "France",
        å¾·å›½: "Germany",
        æ„å¤§åˆ©: "Italy",
        è¥¿ç­ç‰™: "Spain",
        ä¿„ç½—æ–¯: "Russia",
        æ—¥æœ¬: "Japan",
        éŸ©å›½: "South Korea",
        æœé²œ: "North Korea",
        å°åº¦: "India",
        æ¾³å¤§åˆ©äºš: "Australia",
        åŠ æ‹¿å¤§: "Canada",
        å·´è¥¿: "Brazil",
        é˜¿æ ¹å»·: "Argentina",
        å¢¨è¥¿å“¥: "Mexico",
        åŸƒåŠ: "Egypt",
        å—é: "South Africa",
        ä¸­å›½: "People's Republic of China",
        åˆ—æ”¯æ•¦å£«ç™»: "Liechtenstein",
        ç™½ä¿„ç½—æ–¯: "Belarus",
        å°åº¦å°¼è¥¿äºš: "Indonesia",
        æ³¢é»‘: "Bosnia and Herzegovina",
        // è‹±æ–‡ç®€å†™
        USA: "United States of America",
        US: "United States of America",
        UK: "United Kingdom",
        GB: "United Kingdom",
        PRC: "People's Republic of China",
        China: "People's Republic of China",
        ROC: "Republic of China",
        ROK: "Republic of Korea",
        DPRK: "Democratic People's Republic of Korea",
        UAE: "United Arab Emirates",
        KSA: "Saudi Arabia",

        // ç‰¹åˆ«è¡Œæ”¿åŒº
        é¦™æ¸¯: "Hong Kong",
        æ¾³é—¨: "Macau",
        å°æ¹¾: "Taiwan",
        Taiwan: "Taiwan",
      };

      // åˆå§‹åŒ–å‡½æ•°
      async function init() {
        try {
          // åŒæ—¶åŠ è½½ä¸¤ä¸ªJSONæ–‡ä»¶
          const [countryListData, countryInfoData] = await Promise.all([
            fetch("ä¸–ç•Œå›½å®¶/country_data.json").then((r) => r.json()),
            fetch("ä¸–ç•Œå›½å®¶/countries.json").then((r) => r.json()),
          ]);

          // å¤„ç†å›½å®¶æ•°æ®
          countryData = countryListData.countries;
          countryInfoMap = {};

          // åˆ›å»ºå›½å®¶ä¿¡æ¯æ˜ å°„
          countryInfoData.forEach((country) => {
            countryInfoMap[country.id] = country;
          });

          // æ•´ç†æ‰€æœ‰å›½å®¶åˆ—è¡¨
          allCountries = countryData.map((item) => {
            // ä»country_infoä¸­è·å–è¯¦ç»†ä¿¡æ¯
            let svgId = item.svgId;
            let countryInfo = null;

            // å¦‚æœæ˜¯æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ªå…ƒç´ æŸ¥æ‰¾
            if (Array.isArray(svgId)) {
              for (let id of svgId) {
                if (countryInfoMap[id]) {
                  countryInfo = countryInfoMap[id];
                  break;
                }
              }
            } else if (countryInfoMap[svgId]) {
              countryInfo = countryInfoMap[svgId];
            }

            return {
              name: item.name,
              svgId: item.svgId,
              continent: item.continent,
              subRegion: item.subRegion,
              accuracy: item.accuracy || 0,
              name_zh: countryInfo ? countryInfo.name_zh : item.name,
              name_en: countryInfo ? countryInfo.name_en : item.name,
              formal_en: countryInfo ? countryInfo.formal_en : item.name,
            };
          });

          console.log("å›½å®¶æ•°æ®åŠ è½½å®Œæˆï¼Œæ€»æ•°ï¼š", allCountries.length);

          // æ›´æ–°æ€»æ•°é‡
          document.getElementById("total-count").textContent =
            allCountries.length;

          // æ¸²æŸ“åŒºåŸŸåˆ—è¡¨
          renderRegionList();

          // åˆå§‹åŒ–SVGäº¤äº’
          initSVGInteraction();

          // å¯åŠ¨è®¡æ—¶å™¨
          startTimer();
        } catch (error) {
          showMessage("åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥JSONæ–‡ä»¶æ˜¯å¦åœ¨æ­£ç¡®ç›®å½•ï¼", "error");
          console.error("æ•°æ®åŠ è½½é”™è¯¯ï¼š", error);
        }
      }

      // æ­£æ€åˆ†å¸ƒ CDFï¼ˆè¯¯å·®å‡½æ•°è¿‘ä¼¼ï¼‰
      function normalCDF(z) {
        return (1.0 + erf(z / Math.sqrt(2))) / 2.0;
      }

      // è¯¯å·®å‡½æ•° erf è¿‘ä¼¼
      function erf(x) {
        const sign = x >= 0 ? 1 : -1;
        x = Math.abs(x);

        const a1 = 0.254829592;
        const a2 = -0.284496736;
        const a3 = 1.421413741;
        const a4 = -1.453152027;
        const a5 = 1.061405429;
        const p = 0.3275911;

        const t = 1 / (1 + p * x);
        const y =
          1 -
          ((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);

        return sign * y;
      }

      // æ¸²æŸ“åŒºåŸŸåˆ—è¡¨
      function renderRegionList() {
        const listContainer = document.getElementById("region-list");
        listContainer.innerHTML = "";

        // æŒ‰å¤§æ´²å’Œå­åŒºåŸŸåˆ†ç»„
        const groupedByContinent = {};

        allCountries.forEach((country) => {
          const continent = country.continent || "å…¶ä»–";
          const subRegion = country.subRegion || "æœªåˆ†ç±»";

          if (!groupedByContinent[continent]) {
            groupedByContinent[continent] = {};
          }

          if (!groupedByContinent[continent][subRegion]) {
            groupedByContinent[continent][subRegion] = [];
          }

          groupedByContinent[continent][subRegion].push(country);
        });

        // æ¸²æŸ“æ¯ä¸ªå¤§æ´²
        for (const continent in groupedByContinent) {
          const continentGroup = document.createElement("div");
          continentGroup.className = "continent-group";

          const continentName = document.createElement("div");
          continentName.className = "continent-name";
          continentName.textContent = continent;

          continentGroup.appendChild(continentName);

          // æ¸²æŸ“æ¯ä¸ªå­åŒºåŸŸ
          for (const subRegion in groupedByContinent[continent]) {
            const countries = groupedByContinent[continent][subRegion];
            const filledInSubregion = countries.filter((country) =>
              filledCountries.has(country.name)
            ).length;

            const subregionGroup = document.createElement("div");
            subregionGroup.className = "subregion-group";

            const subregionName = document.createElement("div");
            subregionName.className = "subregion-name";
            subregionName.innerHTML = `
                        ${subRegion} 
                        <span class="subregion-progress">${filledInSubregion}/${countries.length}</span>
                    `;

            const countryTags = document.createElement("div");
            countryTags.className = "country-tags";

            countries.forEach((country) => {
              const countryTag = document.createElement("div");

              // å¦‚æœæ¸¸æˆå·²ç»“æŸï¼Œæ˜¾ç¤ºæ‰€æœ‰å›½å®¶
              if (isGameEnded) {
                if (filledCountries.has(country.name)) {
                  countryTag.className = "country-tag filled";
                } else {
                  countryTag.className = "country-tag unfilled";
                }
              } else {
                // æ¸¸æˆè¿›è¡Œä¸­ï¼Œåªæ˜¾ç¤ºå·²ç­”å‡ºçš„å›½å®¶
                countryTag.className = `country-tag ${
                  filledCountries.has(country.name) ? "filled" : ""
                }`;
              }

              countryTag.textContent = country.name;
              countryTags.appendChild(countryTag);
            });

            subregionGroup.appendChild(subregionName);
            subregionGroup.appendChild(countryTags);
            continentGroup.appendChild(subregionGroup);
          }

          listContainer.appendChild(continentGroup);
        }
      }

      // åˆå§‹åŒ–SVGäº¤äº’
      function initSVGInteraction() {
        const svgObj = document.getElementById("world-svg");
        const mapWrapper = document.getElementById("map-wrapper");

        svgObj.addEventListener("load", function () {
          const svgDoc = this.contentDocument;
          if (!svgDoc) return;
          const svgElement = svgDoc.querySelector("svg");
          if (!svgElement) return;

          // å•å‡»ç¼©æ”¾
          svgDoc.addEventListener("click", (e) => {
            const clickX = e.clientX;
            const clickY = e.clientY;
            toggleZoom(svgElement, clickX, clickY);
          });

          // ç»‘å®šå›½å®¶è·¯å¾„çš„äº¤äº’
          const countryPaths = svgDoc.querySelectorAll(
            "path, polygon, circle, ellipse, rect"
          );
          countryPaths.forEach((elem) => {
            const countryId = elem.id;
            if (!countryId) return;

            // æŸ¥æ‰¾å¯¹åº”çš„å›½å®¶
            const country = allCountries.find((c) => {
              if (Array.isArray(c.svgId)) {
                return c.svgId.includes(countryId);
              }
              return c.svgId === countryId;
            });

            if (!country) return;

            // ä¿å­˜åŸå§‹é¢œè‰²
            const originalColor =
              elem.style.fill || window.getComputedStyle(elem).fill;
            originalColors.set(countryId, originalColor);

            elem.style.cursor = "pointer";

            // é¼ æ ‡æ‚¬åœäº‹ä»¶
            elem.addEventListener("mouseover", function (e) {
              if (isGameEnded || filledCountries.has(country.name)) {
                showTooltip(e, country.name);
              }
            });

            elem.addEventListener("mousemove", function (e) {
              if (isGameEnded || filledCountries.has(country.name)) {
                updateTooltipPosition(e);
              }
            });

            elem.addEventListener("mouseout", function () {
              hideTooltip();
            });
          });
        });
      }

      // åˆ‡æ¢ç¼©æ”¾
      function toggleZoom(svgElement, clickX, clickY) {
        if (isZoomed) {
          svgElement.style.transform = `translate(0px, 0px) scale(1)`;
          isZoomed = false;
          document.getElementById("map-wrapper").style.cursor = "zoom-in";
        } else {
          const zoomScale = 2.5;
          const rect = document
            .getElementById("map-wrapper")
            .getBoundingClientRect();
          const centerX = rect.width / 2;
          const centerY = rect.height / 2;

          translateX = centerX - clickX * zoomScale;
          translateY = centerY - clickY * zoomScale;

          svgElement.style.transition =
            "transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)";
          svgElement.style.transformOrigin = "0 0";
          svgElement.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoomScale})`;

          isZoomed = true;
          document.getElementById("map-wrapper").style.cursor = "zoom-out";
        }
      }

      // åŒ¹é…å›½å®¶åç§°
      function matchCountry(input) {
        const normalizedInput = input.trim();

        // 1. å°è¯•å®Œå…¨åŒ¹é…ä¸­æ–‡å
        const exactChineseMatch = allCountries.find(
          (country) =>
            country.name === normalizedInput ||
            country.name_zh === normalizedInput
        );
        if (exactChineseMatch) return exactChineseMatch;

        // 2. å°è¯•å®Œå…¨åŒ¹é…è‹±æ–‡å
        const exactEnglishMatch = allCountries.find(
          (country) =>
            country.name_en === normalizedInput ||
            country.formal_en === normalizedInput ||
            (country.name_en &&
              country.name_en.toLowerCase() ===
                normalizedInput.toLowerCase()) ||
            (country.formal_en &&
              country.formal_en.toLowerCase() === normalizedInput.toLowerCase())
        );
        if (exactEnglishMatch) return exactEnglishMatch;

        // 3. å°è¯•ç®€å†™æ˜ å°„
        if (shortNameMap[normalizedInput]) {
          const shortName = shortNameMap[normalizedInput];
          const shortNameMatch = allCountries.find(
            (country) =>
              country.name_en === shortName ||
              country.formal_en === shortName ||
              (country.name_en &&
                country.name_en.toLowerCase() === shortName.toLowerCase())
          );
          if (shortNameMatch) return shortNameMatch;
        }

        // 4. å°è¯•éƒ¨åˆ†åŒ¹é…
        const partialMatch = allCountries.find((country) => {
          // æ£€æŸ¥ä¸­æ–‡ååŒ…å«è¾“å…¥
          if (
            country.name.includes(normalizedInput) ||
            country.name_zh.includes(normalizedInput)
          ) {
            return true;
          }

          // æ£€æŸ¥è‹±æ–‡ååŒ…å«è¾“å…¥ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
          if (
            (country.name_en &&
              country.name_en
                .toLowerCase()
                .includes(normalizedInput.toLowerCase())) ||
            (country.formal_en &&
              country.formal_en
                .toLowerCase()
                .includes(normalizedInput.toLowerCase()))
          ) {
            return true;
          }

          return false;
        });

        return partialMatch || null;
      }

      // æäº¤å›½å®¶ç­”æ¡ˆ
      function submitCountry(input) {
        if (isGameEnded) return;

        totalAttempts++;
        const matchedCountry = matchCountry(input);

        if (!matchedCountry) {
          showMessage(`âŒ æ— æ³•è¯†åˆ«ã€${input}ã€‘ï¼Œè¯·æ£€æŸ¥è¾“å…¥ï¼`, "error");
          return;
        }

        // æ£€æŸ¥æ˜¯å¦å·²å¡«å†™
        if (filledCountries.has(matchedCountry.name)) {
          showMessage(`ä½ å·²ç»å¡«å†™è¿‡ã€${matchedCountry.name}ã€‘å•¦ï¼`, "error");
          return;
        }

        // æ­£ç¡®ç­”æ¡ˆå¤„ç†
        correctAttempts++;
        filledCountries.add(matchedCountry.name);

        // æ›´æ–°ç»Ÿè®¡
        updateStats();

        // æ›´æ–°SVGæ ·å¼
        updateSVGCountryStyle(matchedCountry);

        // æ›´æ–°åŒºåŸŸåˆ—è¡¨
        renderRegionList();

        // æç¤ºæˆåŠŸ
        showMessage(`âœ… æ­£ç¡®ï¼å·²å¡«å†™ã€${matchedCountry.name}ã€‘`, "success");

        // æ¸…ç©ºè¾“å…¥æ¡†å¹¶è‡ªåŠ¨èšç„¦
        const inputElement = document.getElementById("country-input");
        inputElement.value = "";
        inputElement.focus();

        // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
        if (filledCountries.size === allCountries.length) {
          endGame();
        }
      }

      // æ›´æ–°SVGä¸­å›½å®¶æ ·å¼
      function updateSVGCountryStyle(country) {
        const svgObj = document.getElementById("world-svg");
        const svgDoc = svgObj.contentDocument;
        if (!svgDoc) return;

        // æ ¹æ®svgIdæŸ¥æ‰¾å¯¹åº”çš„å…ƒç´ 
        let selectors = [];
        if (Array.isArray(country.svgId)) {
          selectors = country.svgId.map((id) => `#${id}`);
        } else {
          selectors = [`#${country.svgId}`];
        }

        selectors.forEach((selector) => {
          const elements = svgDoc.querySelectorAll(selector);
          elements.forEach((elem) => {
            elem.style.fill = "#2ecc71";
            elem.style.transition = "fill 0.3s";
          });
        });
      }

      // æ›´æ–°ç»Ÿè®¡æ•°æ®
      function updateStats() {
        document.getElementById("filled-count").textContent =
          filledCountries.size;
      }

      // å¯åŠ¨è®¡æ—¶å™¨
      function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const minutes = Math.floor(elapsed / 60)
            .toString()
            .padStart(2, "0");
          const seconds = (elapsed % 60).toString().padStart(2, "0");
          document.getElementById(
            "timer"
          ).textContent = `${minutes}:${seconds}`;
        }, 1000);
      }

      // ç»“æŸæ¸¸æˆ
      function endGame() {
        if (isGameEnded) return;
        isGameEnded = true;
        clearInterval(timerInterval);

        // æ›´æ–°åŒºåŸŸåˆ—è¡¨ï¼Œæ˜¾ç¤ºæ‰€æœ‰å›½å®¶
        renderRegionList();

        // è®¡ç®—ç»Ÿè®¡
        const totalCountries = allCountries.length;
        const accuracy = Math.round(
          (filledCountries.size / totalCountries) * 100
        );
        const time = document.getElementById("timer").textContent;

        // æ˜¾ç¤ºç»“æœ
        showResult(accuracy, time);

        showMessage("ğŸ‰ æ¸¸æˆç»“æŸï¼æŸ¥çœ‹ç»“æœç»Ÿè®¡", "success");
      }

      // æ˜¾ç¤ºç»“æœå¼¹çª—
      function showResult(accuracy, time) {
        const userScore = filledCountries.size;

        // === ç»Ÿè®¡å‡è®¾ ===
        const meanScore = 119;
        const stdDev = 20;

        const z = (userScore - meanScore) / stdDev;
        const percentile = Math.round(normalCDF(z) * 100);

        const resultStats = document.getElementById("result-stats");
        resultStats.innerHTML = `
        <div class="result-stat">
            <span class="result-label">ä½ çš„å¾—åˆ†</span>
            <span class="result-value">${userScore}</span>
        </div>
        <div class="result-stat">
            <span class="result-label">å¹³å‡å¾—åˆ†</span>
            <span class="result-value">${meanScore}</span>
        </div>
        <div class="result-stat">
            <span class="result-label">è¶…è¿‡ç”¨æˆ·æ¯”ä¾‹</span>
            <span class="result-value result-accuracy">
                è¶…è¿‡ ${percentile}% çš„ç”¨æˆ·
            </span>
        </div>
        <div class="result-stat">
            <span class="result-label">å®Œæˆå›½å®¶</span>
            <span class="result-value">${userScore}/${allCountries.length}</span>
        </div>
        <div class="result-stat">
            <span class="result-label">æ€»ç”¨æ—¶</span>
            <span class="result-value">${time}</span>
        </div>
        <div class="result-stat">
            <span class="result-label">æ­£ç¡®ç‡</span>
            <span class="result-value">${accuracy}%</span>
        </div>
    `;

        renderCountryStatsList();
        document.getElementById("result-modal").style.display = "flex";

        // æ˜¾ç¤ºâ€œå†æ¬¡æŸ¥çœ‹ç»“æœâ€æŒ‰é’®
        document.getElementById("view-result-btn").style.display =
          "inline-block";
      }

      // æ¸²æŸ“å›½å®¶ç»Ÿè®¡åˆ—è¡¨
      function renderCountryStatsList() {
        const listContainer = document.getElementById("city-stats-list");
        listContainer.innerHTML =
          '<h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: #2c3e50;">å›½å®¶è¯†åˆ«æƒ…å†µï¼ˆç»¿è‰²ä¸ºæ‚¨ç­”å¯¹ï¼‰</h3>';

        // æŒ‰å¤§æ´²åˆ†ç»„æ˜¾ç¤º
        const groupedByContinent = {};
        allCountries.forEach((country) => {
          const continent = country.continent || "å…¶ä»–";
          if (!groupedByContinent[continent]) {
            groupedByContinent[continent] = [];
          }
          groupedByContinent[continent].push(country);
        });

        // å¯¹æ¯ä¸ªå¤§æ´²çš„å›½å®¶æŒ‰å­—æ¯æ’åº
        for (const continent in groupedByContinent) {
          const continentHeader = document.createElement("h4");
          continentHeader.style.margin = "0.5rem 0";
          continentHeader.style.color = "#34495e";
          continentHeader.textContent = continent;
          listContainer.appendChild(continentHeader);

          const countries = groupedByContinent[continent].sort((a, b) =>
            a.name.localeCompare(b.name, "zh-CN")
          );

          countries.forEach((country) => {
            const isAnsweredCorrectly = filledCountries.has(country.name);

            const row = document.createElement("div");
            row.className = "city-stat-row";

            const countryNameCol = document.createElement("div");
            countryNameCol.className = "city-name";
            countryNameCol.textContent = country.name;

            const barContainer = document.createElement("div");
            barContainer.className = "bar-container";

            const barFill = document.createElement("div");
            barFill.className = `bar-fill ${
              isAnsweredCorrectly ? "correct" : ""
            }`;
            barFill.style.width = `${Math.min(country.accuracy || 50, 100)}%`;

            const percentCol = document.createElement("div");
            percentCol.className = "percent-text";
            percentCol.textContent = `${country.accuracy || "N/A"}`;

            barContainer.appendChild(barFill);
            row.appendChild(countryNameCol);
            row.appendChild(barContainer);
            row.appendChild(percentCol);
            listContainer.appendChild(row);
          });
        }
      }

      // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
      function showMessage(text, type) {
        const messageEl = document.getElementById("message");
        messageEl.textContent = text;
        messageEl.className = `message ${type}`;

        setTimeout(() => {
          messageEl.className = "message";
        }, 3000);
      }

      // æ˜¾ç¤ºæç¤ºæ¡†
      function showTooltip(e, countryName) {
        tooltip.textContent = countryName;
        tooltip.style.opacity = 1;
        updateTooltipPosition(e);
      }

      // æ›´æ–°æç¤ºæ¡†ä½ç½®
      function updateTooltipPosition(e) {
        const offset = 12;

        let x = e.clientX + offset;
        let y = e.clientY + offset;

        const tooltipRect = tooltip.getBoundingClientRect();

        // é˜²æ­¢è¶…å‡ºå³è¾¹ç•Œ
        if (x + tooltipRect.width > window.innerWidth) {
          x = e.clientX - tooltipRect.width - offset;
        }

        // é˜²æ­¢è¶…å‡ºä¸‹è¾¹ç•Œ
        if (y + tooltipRect.height > window.innerHeight) {
          y = e.clientY - tooltipRect.height - offset;
        }

        tooltip.style.left = `${x}px`;
        tooltip.style.top = `${y}px`;
      }

      // éšè—æç¤ºæ¡†
      function hideTooltip() {
        tooltip.style.opacity = 0;
      }

      // é‡ç½®æŒ‘æˆ˜
      function resetChallenge() {
        filledCountries.clear();
        totalAttempts = 0;
        correctAttempts = 0;
        isGameEnded = false;

        isZoomed = false;
        scale = 1;
        translateX = 0;
        translateY = 0;

        clearInterval(timerInterval);
        startTimer();

        updateStats();
        renderRegionList();

        // é‡ç½®SVGæ ·å¼ - ä½¿ç”¨ä¿å­˜çš„åŸå§‹é¢œè‰²
        const svgObj = document.getElementById("world-svg");
        if (svgObj.contentDocument) {
          const countryPaths = svgObj.contentDocument.querySelectorAll(
            "path, polygon, circle, ellipse, rect"
          );
          countryPaths.forEach((elem) => {
            const countryId = elem.id;
            if (countryId && originalColors.has(countryId)) {
              elem.style.fill = originalColors.get(countryId);
            }
          });

          // é‡ç½®åœ°å›¾ç¼©æ”¾
          const svgElement = svgObj.contentDocument.querySelector("svg");
          if (svgElement) {
            svgElement.style.transform = `translate(0px, 0px) scale(1)`;
            svgElement.style.transformOrigin = "0 0";
          }
        }

        // éšè—æç¤ºæ¡†
        hideTooltip();

        // èšç„¦è¾“å…¥æ¡†
        document.getElementById("country-input").focus();

        showMessage("ğŸ”„ å·²é‡ç½®æŒ‘æˆ˜ï¼Œé‡æ–°å¼€å§‹ï¼", "success");
      }

      // äº‹ä»¶ç›‘å¬
      document.addEventListener("DOMContentLoaded", () => {
        // åˆå§‹åŒ–
        init();

        // æäº¤æŒ‰é’®ç‚¹å‡»
        document.getElementById("submit-btn").addEventListener("click", () => {
          const input = document.getElementById("country-input").value.trim();
          if (input) {
            submitCountry(input);
          } else {
            showMessage("è¯·è¾“å…¥å›½å®¶åç§°ï¼", "error");
          }
        });

        // ç»“æŸæŒ‰é’®ç‚¹å‡»
        document.getElementById("end-btn").addEventListener("click", () => {
          if (!isGameEnded) {
            endGame();
          }
        });

        // è¾“å…¥æ¡†å›è½¦æäº¤
        document
          .getElementById("country-input")
          .addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              const input = e.target.value.trim();
              if (input) {
                submitCountry(input);
              }
            }
          });

        // é‡ç½®æŒ‰é’®
        document
          .getElementById("reset-btn")
          .addEventListener("click", resetChallenge);

        // å…³é—­ç»“æœå¼¹çª—
        document
          .getElementById("close-result-btn")
          .addEventListener("click", () => {
            document.getElementById("result-modal").style.display = "none";
          });

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document
          .getElementById("result-modal")
          .addEventListener("click", (e) => {
            if (e.target === document.getElementById("result-modal")) {
              document.getElementById("result-modal").style.display = "none";
            }
          });

        // åˆå§‹èšç„¦è¾“å…¥æ¡†
        document.getElementById("country-input").focus();
      });
      document
        .getElementById("view-result-btn")
        .addEventListener("click", () => {
          document.getElementById("result-modal").style.display = "flex";
        });
    </script>
  </body>
</html>
