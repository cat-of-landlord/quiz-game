<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¸­å›½åœ°çº§å¸‚å¡«å›¾æŒ‘æˆ˜ | åœ°ç†é—®ç­”</title>
    <style>
      /* å…¨å±€æ ·å¼é‡ç½® */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Microsoft YaHei", Arial, sans-serif;
      }

      body {
        background-color: #f5f7fa;
        color: #333;
        line-height: 1.6;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* å¤´éƒ¨æ ·å¼ */
      header {
        background: linear-gradient(135deg, #2c3e50, #34495e);
        color: white;
        padding: 1.5rem 2rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        position: relative;
      }

      .back-btn {
        position: absolute;
        left: 2rem;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 0.5rem 1.2rem;
        border-radius: 20px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
      }

      .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-50%) scale(1.05);
      }

      .stats-bar {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-top: 1rem;
        flex-wrap: wrap;
      }

      .stat-item {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1.2rem;
        border-radius: 20px;
        font-size: 1rem;
      }

      .stat-number {
        font-weight: bold;
        color: #3498db;
        font-size: 1.2rem;
      }

      /* ä¸»å®¹å™¨ */
      .main-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
        padding: 2rem 1rem;
      }

      /* åœ°å›¾å’Œåˆ—è¡¨å®¹å™¨ */
      .content-wrapper {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
        flex: 1;
      }

      @media (max-width: 992px) {
        .content-wrapper {
          grid-template-columns: 1fr;
        }
      }

      /* åœ°å›¾åŒºåŸŸ */
      .map-section {
        background: white;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: hidden;
        height: 600px;
      }

      .map-tip {
        padding: 0.8rem 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 0.8rem;
        font-size: 0.9rem;
        color: #555;
        line-height: 1.5;
        border-left: 3px solid #3498db;
      }

      .map-wrapper {
        width: 100%;
        height: calc(100% - 50px);
        position: relative;
        overflow: hidden;
        cursor: pointer;
      }

      #city-svg {
        width: 100%;
        height: 100%;
        min-width: 800px;
        min-height: 600px;
        transition: transform 0.3s ease;
      }

      /* çœä»½åˆ—è¡¨åŒºåŸŸ */
      .province-list {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        max-height: 600px;
        overflow-y: auto;
      }

      .province-group {
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 1rem;
      }

      .province-name {
        font-size: 1.1rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 0.8rem;
        display: flex;
        justify-content: space-between;
      }

      .province-progress {
        font-size: 0.9rem;
        color: #7f8c8d;
      }

      .city-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .city-tag {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.9rem;
        background: #ecf0f1;
        color: #7f8c8d;
        transition: all 0.3s;
        display: none;
      }

      .city-tag.filled {
        display: inline-block;
        background: #2ecc71;
        color: white;
      }

      .city-tag.unfilled {
        display: inline-block;
        background: #e74c3c;
        color: white;
      }

      /* è¾“å…¥æ åŒºåŸŸ */
      .input-section-container {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 1.5rem 2rem;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        border-top: 1px solid #e0e0e0;
        z-index: 1000;
        margin-top: auto;
        transition: all 0.3s ease;
      }

      .input-section {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .input-wrapper {
        flex: 1;
        min-width: 300px;
        position: relative;
      }

      #city-input {
        width: 100%;
        padding: 0.8rem 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.3s;
      }

      #city-input:focus {
        border-color: #3498db;
      }

      /* æŒ‰é’®æ ·å¼ */
      .button-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
      }

      .btn-submit {
        background: #3498db;
        color: white;
      }

      .btn-submit:hover {
        background: #2980b9;
      }

      .btn-end {
        background: #9b59b6;
        color: white;
      }

      .btn-end:hover {
        background: #8e44ad;
      }

      .btn-reset {
        background: #e74c3c;
        color: white;
      }

      .btn-reset:hover {
        background: #c0392b;
      }

      /* æ–°å¢ï¼šæŸ¥çœ‹ç»“æœæŒ‰é’®æ ·å¼ */
      .btn-show-result {
        background: #f39c12;
        color: white;
        display: none; /* é»˜è®¤éšè— */
      }
      .btn-show-result:hover {
        background: #d35400;
      }

      /* æç¤ºæ¶ˆæ¯ */
      .message {
        width: 100%;
        margin-top: 1rem;
        padding: 0.8rem;
        border-radius: 8px;
        font-weight: bold;
        display: none;
      }

      .success {
        background: #d5f5e3;
        color: #27ae60;
        display: block;
      }

      .error {
        background: #fadbd8;
        color: #e74c3c;
        display: block;
      }

      /* ç»“æœå¼¹çª— */
      .result-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }

      .result-content {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        max-width: 800px;
        width: 95%;
        max-height: 90vh;
        overflow-y: auto;
        text-align: center;
      }

      .result-title {
        font-size: 1.5rem;
        color: #2c3e50;
        margin-bottom: 1.5rem;
      }

      .result-stats {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .result-stat {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #eee;
      }

      .result-label {
        color: #7f8c8d;
      }

      .result-value {
        font-weight: bold;
        color: #2c3e50;
      }

      .result-accuracy {
        font-size: 1.2rem;
        color: #e74c3c;
      }

      /* é‡ç½®æŒ‰é’® */
      .reset-section {
        text-align: center;
        margin-top: 2rem;
        flex-shrink: 0;
      }

      /* åŸå¸‚åç§°æç¤ºæ¡† */
      .city-tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-size: 0.9rem;
        pointer-events: none;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.2s ease;
        white-space: nowrap;
      }

      /* å“åº”å¼é€‚é… */
      @media (max-width: 768px) {
        .main-container {
          padding: 1rem;
        }

        .content-wrapper {
          gap: 1rem;
        }

        .map-section,
        .province-list {
          max-height: 500px;
        }

        .input-section {
          flex-direction: column;
        }

        .input-wrapper {
          min-width: 100%;
        }

        .button-group {
          width: 100%;
        }

        .btn {
          flex: 1;
          text-align: center;
        }

        .stats-bar {
          gap: 1rem;
        }

        .stat-item {
          padding: 0.3rem 0.8rem;
          font-size: 0.9rem;
        }

        .back-btn {
          padding: 0.3rem 0.8rem;
          font-size: 0.9rem;
          left: 1rem;
        }

        .map-tip {
          font-size: 0.8rem;
          padding: 0.6rem 0.8rem;
        }

        .map-wrapper {
          height: calc(100% - 45px);
        }
      }

      @media (max-width: 576px) {
        .map-section {
          height: 400px;
        }

        .province-list {
          max-height: 400px;
        }

        .button-group {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }

      /* ç»“æœæ»šåŠ¨åŒºåŸŸä¼˜åŒ– */
      .stat-detail {
        font-size: 0.9rem;
        color: #666;
        margin-top: 5px;
        line-height: 1.4;
      }
      .highlight-val {
        color: #2c3e50;
        font-weight: bold;
      }
      .city-stats-list {
        margin-top: 20px;
        border-top: 1px solid #eee;
        padding-top: 15px;
      }
      .city-stat-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
      }
      .bar-container {
        flex: 1;
        height: 8px;
        background-color: #f0f0f0;
        border-radius: 4px;
        overflow: hidden;
      }
      .bar-fill {
        height: 100%;
        background-color: #ff4444;
        transition: width 0.3s ease;
      }
      .bar-fill.correct {
        background-color: #4caf50;
      }
      .percent-text {
        width: 40px;
        text-align: right;
        font-size: 0.9rem;
        font-weight: bold;
      }
      .city-name {
        width: 120px;
        text-align: left;
        font-size: 0.9rem;
      }
      .final-stats {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <header>
      <a href="index.html" class="back-btn">â† è¿”å›é¦–é¡µ</a>
      <h1>ä¸­å›½åœ°çº§å¸‚å¡«å›¾æŒ‘æˆ˜</h1>
      <div class="stats-bar">
        <div class="stat-item">
          å·²å¡«/æ€»æ•°ï¼š<span id="filled-count" class="stat-number">0</span>/<span
            id="total-count"
            class="stat-number"
            >0</span
          >
        </div>
        <div class="stat-item">
          ç”¨æ—¶ï¼š<span id="timer" class="stat-number">00:00</span>
        </div>
      </div>
    </header>

    <div class="main-container">
      <div class="content-wrapper">
        <div class="map-section">
          <div class="map-tip">
            ğŸ”
            å¡«å†™è§„åˆ™ï¼š1.ç›´è¾–å¸‚/ç‰¹åˆ«è¡Œæ”¿åŒºç›´æ¥è¾“å…¥åç§°ï¼ˆå¦‚ï¼šåŒ—äº¬ã€é¦™æ¸¯ï¼‰ï¼›2.çœçº§ç›´è¾–å¿éœ€è¾“å…¥å¿åå¦‚:xxå¿ï¼ˆç®—åœ°çº§ï¼‰ï¼›3.è‡ªæ²»å·å¯è¾“å…¥ç®€å†™ï¼›4.åœ°å›¾å•å‡»ä»»æ„ä½ç½®æ”¾å¤§ï¼ˆä»¥ç‚¹å‡»ä½ç½®ä¸ºä¸­å¿ƒï¼‰ï¼Œå†æ¬¡å•å‡»å¤åŸã€‚5.é¼ æ ‡æ‚¬æµ®å¯ä»¥æ˜¾ç¤ºå·²ç­”å‡ºåŸå¸‚å
          </div>
          <div class="map-wrapper" id="map-wrapper">
            <object
              id="city-svg"
              data="cities_new.svg"
              type="image/svg+xml"
            ></object>
            <div class="city-tooltip" id="city-tooltip"></div>
          </div>
        </div>

        <div class="province-list" id="province-list"></div>
      </div>

      <div class="reset-section">
        <button id="reset-btn" class="btn btn-reset">é‡æ–°å¼€å§‹æŒ‘æˆ˜</button>
      </div>
    </div>

    <div class="input-section-container">
      <div class="input-section">
        <div class="input-wrapper">
          <input
            type="text"
            id="city-input"
            placeholder="è¾“å…¥åœ°çº§å¸‚åç§°ï¼ˆæ”¯æŒç®€å†™ï¼Œå¦‚ï¼šåŒ—äº¬ã€é¦™æ¸¯ç­‰ï¼‰"
            autocomplete="off"
          />
        </div>
        <div class="button-group">
          <button id="submit-btn" class="btn btn-submit">æäº¤ç­”æ¡ˆ</button>
          <button id="end-btn" class="btn btn-end">ç»“æŸæŒ‘æˆ˜</button>
          <button id="show-result-btn" class="btn btn-show-result">
            æŸ¥çœ‹ç»“æœ
          </button>
        </div>
        <div class="message" id="message"></div>
      </div>
    </div>

    <div class="result-modal" id="result-modal">
      <div class="result-content">
        <h2 class="result-title">æŒ‘æˆ˜ç»“æŸï¼</h2>
        <div id="final-stats" class="final-stats"></div>
        <div class="result-stats" id="result-stats"></div>
        <button id="close-result-btn" class="btn btn-reset">å…³é—­</button>
        <div class="city-stats-list" id="city-stats-list">
          <h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: #2c3e50">
            å…¨ç½‘åŸå¸‚è¯†åˆ«çƒ­åº¦æ¦œï¼ˆç»¿è‰²ä¸ºæ‚¨ç­”å¯¹ï¼‰
          </h3>
        </div>
      </div>
    </div>

    <script>
      // æ ¸å¿ƒæ•°æ®å­˜å‚¨
      let cityData = {};
      let mergedData = {};
      let allCities = [];
      let filledCities = new Set();
      let totalAttempts = 0;
      let correctAttempts = 0;
      let timerInterval = null;
      let startTime = 0;
      let isGameEnded = false;
      let accuracyData = [];

      let isZoomed = false;
      let scale = 1;
      let translateX = 0;
      let translateY = 0;

      const tooltip = document.getElementById("city-tooltip");

      const shortNameMap = {
        é¦™æ¸¯: "é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº",
        æ¾³é—¨: "æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº",
        æµ·å—: "æµ·å—è—æ—è‡ªæ²»å·",
        æµ·åŒ—: "æµ·åŒ—è—æ—è‡ªæ²»å·",
        é»„å—: "é»„å—è—æ—è‡ªæ²»å·",
        æœæ´›: "æœæ´›è—æ—è‡ªæ²»å·",
        ç‰æ ‘: "ç‰æ ‘è—æ—è‡ªæ²»å·",
        æµ·è¥¿: "æµ·è¥¿è’™å¤æ—è—æ—è‡ªæ²»å·",
        æ˜Œå‰: "æ˜Œå‰å›æ—è‡ªæ²»å·",
        åšå°”å¡”æ‹‰: "åšå°”å¡”æ‹‰è’™å¤è‡ªæ²»å·",
        å·´éŸ³éƒ­æ¥: "å·´éŸ³éƒ­æ¥è’™å¤è‡ªæ²»å·",
        å…‹å­œå‹’è‹: "å…‹å­œå‹’è‹æŸ¯å°”å…‹å­œè‡ªæ²»å·",
        ä¼ŠçŠ: "ä¼ŠçŠå“ˆè¨å…‹è‡ªæ²»å·",
        æ¹˜è¥¿: "æ¹˜è¥¿åœŸå®¶æ—è‹—æ—è‡ªæ²»å·",
        æ©æ–½: "æ©æ–½åœŸå®¶æ—è‹—æ—è‡ªæ²»å·",
        å»¶è¾¹: "å»¶è¾¹æœé²œæ—è‡ªæ²»å·",
        é˜¿å: "é˜¿åè—æ—ç¾Œæ—è‡ªæ²»å·",
        ç”˜å­œ: "ç”˜å­œè—æ—è‡ªæ²»å·",
        å‡‰å±±: "å‡‰å±±å½æ—è‡ªæ²»å·",
        é»”ä¸œå—: "é»”ä¸œå—è‹—æ—ä¾—æ—è‡ªæ²»å·",
        é»”å—: "é»”å—å¸ƒä¾æ—è‹—æ—è‡ªæ²»å·",
        é»”è¥¿å—: "é»”è¥¿å—å¸ƒä¾æ—è‹—æ—è‡ªæ²»å·",
        è¥¿åŒç‰ˆçº³: "è¥¿åŒç‰ˆçº³å‚£æ—è‡ªæ²»å·",
        å¾·å®: "å¾·å®å‚£æ—æ™¯é¢‡æ—è‡ªæ²»å·",
        æ€’æ±Ÿ: "æ€’æ±Ÿå‚ˆåƒ³æ—è‡ªæ²»å·",
        è¿ªåº†: "è¿ªåº†è—æ—è‡ªæ²»å·",
        çº¢æ²³: "çº¢æ²³å“ˆå°¼æ—å½æ—è‡ªæ²»å·",
        æ–‡å±±: "æ–‡å±±å£®æ—è‹—æ—è‡ªæ²»å·",
        æ¥šé›„: "æ¥šé›„å½æ—è‡ªæ²»å·",
        å¤§ç†: "å¤§ç†ç™½æ—è‡ªæ²»å·",
        ä¸´å¤: "ä¸´å¤å›æ—è‡ªæ²»å·",
        ç”˜å—: "ç”˜å—è—æ—è‡ªæ²»å·",
      };

      async function init() {
        try {
          const [cityListData, accData] = await Promise.all([
            fetch("province_city_list.json").then((r) => r.json()),
            fetch("city_accuracy.json").then((r) => r.json()),
          ]);

          cityData = cityListData;
          accuracyData = accData.city_accuracy_list;

          mergeSpecialRegions();

          for (const province in mergedData) {
            allCities = [...allCities, ...mergedData[province]];
          }
          allCities = [...new Set(allCities)];
          document.getElementById("total-count").textContent = allCities.length;

          renderProvinceList();
          initSVGInteraction();
          startTimer();

          console.log("åˆå§‹åŒ–å®Œæˆï¼Œæ€»åŸå¸‚æ•°ï¼š", allCities.length);
        } catch (error) {
          showMessage("åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼", "error");
          console.error("æ•°æ®åŠ è½½é”™è¯¯ï¼š", error);
        }
      }

      function mergeSpecialRegions() {
        const specialRegions = [
          "åŒ—äº¬å¸‚",
          "å¤©æ´¥å¸‚",
          "ä¸Šæµ·å¸‚",
          "é‡åº†å¸‚",
          "é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº",
          "æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº",
        ];
        const mergedCities = [];

        specialRegions.forEach((region) => {
          if (cityData[region]) {
            mergedCities.push(...cityData[region]);
            delete cityData[region];
          }
        });

        mergedData = {
          ç›´è¾–å¸‚åŠç‰¹åˆ«è¡Œæ”¿åŒº: mergedCities,
          ...cityData,
        };
      }

      function renderProvinceList() {
        const listContainer = document.getElementById("province-list");
        listContainer.innerHTML = "";

        for (const province in mergedData) {
          const cities = mergedData[province];
          const filledInProvince = cities.filter((city) =>
            filledCities.has(city)
          ).length;

          const provinceGroup = document.createElement("div");
          provinceGroup.className = "province-group";

          const provinceName = document.createElement("div");
          provinceName.className = "province-name";
          provinceName.innerHTML = `
                    ${province} 
                    <span class="province-progress">${filledInProvince}/${cities.length}</span>
                `;

          const cityTags = document.createElement("div");
          cityTags.className = "city-tags";

          cities.forEach((city) => {
            const cityTag = document.createElement("div");

            if (isGameEnded) {
              if (filledCities.has(city)) {
                cityTag.className = "city-tag filled";
              } else {
                cityTag.className = "city-tag unfilled";
              }
            } else {
              cityTag.className = `city-tag ${
                filledCities.has(city) ? "filled" : ""
              }`;
            }

            cityTag.textContent = city;
            cityTags.appendChild(cityTag);
          });

          provinceGroup.appendChild(provinceName);
          provinceGroup.appendChild(cityTags);
          listContainer.appendChild(provinceGroup);
        }
      }

      // --- ä¿®æ”¹ï¼šä¼˜åŒ–çš„SVGäº¤äº’é€»è¾‘ ---
      function initSVGInteraction() {
        const svgObj = document.getElementById("city-svg");

        svgObj.addEventListener("load", function () {
          const svgDoc = this.contentDocument;
          if (!svgDoc) return;
          const svgElement = svgDoc.querySelector("svg");
          if (!svgElement) return;

          svgDoc.addEventListener("click", (e) => {
            const clickX = e.clientX;
            const clickY = e.clientY;
            toggleZoom(svgElement, clickX, clickY);
          });

          const cityElements = svgDoc.querySelectorAll("[data-name]");
          cityElements.forEach((elem) => {
            const cityName = elem.getAttribute("data-name").trim();
            if (!cityName) return;

            elem.style.transition = "fill 0.3s";
            elem.style.cursor = "pointer";

            elem.addEventListener("mouseover", function (e) {
              // 1. é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼šé˜²æ­¢è§¦å‘çˆ¶çº§â€œä¸­å›½â€æˆ–èƒŒæ™¯ç»„çš„äº‹ä»¶
              e.stopPropagation();

              // 2. å¼ºåˆ¶è¿‡æ»¤ï¼šå¦‚æœè·å–åˆ°çš„åå­—æ˜¯"ä¸­å›½"ï¼Œç›´æ¥ä¸å¤„ç†
              // è¿™èƒ½è§£å†³ä½ é‡åˆ°çš„â€œé¼ æ ‡åœ¨å“ªé‡Œéƒ½æ˜¾ç¤ºä¸­å›½â€çš„é—®é¢˜
              if (cityName === "ä¸­å›½" || cityName === "China") return;

              // 3. æ˜¾ç¤ºé€»è¾‘ï¼šå¦‚æœå·²ç­”å‡º OR æ¸¸æˆå·²ç»“æŸï¼Œéƒ½æ˜¾ç¤ºåå­—
              if (filledCities.has(cityName) || isGameEnded) {
                showTooltip(e, cityName);
              }

              // 4. é«˜äº®é€»è¾‘ï¼šä»…åœ¨æ¸¸æˆè¿›è¡Œä¸­ä¸”æœªç­”å‡ºçš„æƒ…å†µä¸‹å˜è‰²
              if (!isGameEnded && !filledCities.has(cityName)) {
                this.style.fill = "#3498db";
              }
            });

            elem.addEventListener("mouseout", function (e) {
              e.stopPropagation(); // åŒæ ·é˜»æ­¢å†’æ³¡
              hideTooltip();
              if (!filledCities.has(cityName) && !isGameEnded) {
                this.style.fill = "";
              }
            });
          });
        });
      }

      function toggleZoom(svgElement, clickX, clickY) {
        if (isZoomed) {
          svgElement.style.transform = `translate(0px, 0px) scale(1)`;
          isZoomed = false;
          document.getElementById("map-wrapper").style.cursor = "zoom-in";
        } else {
          const zoomScale = 2.5;
          const rect = document
            .getElementById("map-wrapper")
            .getBoundingClientRect();
          const centerX = rect.width / 2;
          const centerY = rect.height / 2;

          translateX = centerX - clickX * zoomScale;
          translateY = centerY - clickY * zoomScale;

          svgElement.style.transition =
            "transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)";
          svgElement.style.transformOrigin = "0 0";
          svgElement.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoomScale})`;

          isZoomed = true;
          document.getElementById("map-wrapper").style.cursor = "zoom-out";
        }
      }

      function matchCity(input) {
        const normalizedInput = input.trim();
        if (allCities.includes(normalizedInput)) {
          return normalizedInput;
        }
        if (shortNameMap[normalizedInput]) {
          return shortNameMap[normalizedInput];
        }
        const suffixes = ["å¸‚", "ç‰¹åˆ«è¡Œæ”¿åŒº", "è‡ªæ²»å·", "åœ°åŒº", "ç›Ÿ", "æ—åŒº"];
        for (const city of allCities) {
          if (city === normalizedInput) return city;
          for (const suffix of suffixes) {
            if (city.endsWith(suffix)) {
              const cityWithoutSuffix = city.slice(0, -suffix.length);
              if (cityWithoutSuffix === normalizedInput) return city;
            }
          }
        }
        if (["åŒ—äº¬", "å¤©æ´¥", "ä¸Šæµ·", "é‡åº†"].includes(normalizedInput))
          return normalizedInput + "å¸‚";
        if (normalizedInput === "é¦™æ¸¯" || normalizedInput === "æ¾³é—¨")
          return normalizedInput + "ç‰¹åˆ«è¡Œæ”¿åŒº";
        return null;
      }

      function submitCity(input) {
        if (isGameEnded) return;

        totalAttempts++;
        const matchedCity = matchCity(input);

        if (!matchedCity) {
          showMessage(`âŒ æ— æ³•è¯†åˆ«ã€${input}ã€‘ï¼Œè¯·æ£€æŸ¥è¾“å…¥ï¼`, "error");
          return;
        }

        if (filledCities.has(matchedCity)) {
          showMessage(`ä½ å·²ç»å¡«å†™è¿‡ã€${matchedCity}ã€‘å•¦ï¼`, "error");
          return;
        }

        correctAttempts++;
        filledCities.add(matchedCity);
        updateStats();
        updateSVGCityStyle(matchedCity);
        renderProvinceList();
        showMessage(`âœ… æ­£ç¡®ï¼å·²å¡«å†™ã€${matchedCity}ã€‘`, "success");

        const inputElement = document.getElementById("city-input");
        inputElement.value = "";
        inputElement.focus();

        if (filledCities.size === allCities.length) {
          endGame();
        }
      }

      function updateSVGCityStyle(cityName) {
        const svgObj = document.getElementById("city-svg");
        const svgDoc = svgObj.contentDocument;
        if (!svgDoc) return;

        const cityElements = svgDoc.querySelectorAll(
          `[data-name="${cityName}"]`
        );
        cityElements.forEach((elem) => {
          elem.style.fill = "#2ecc71";
        });
      }

      function updateStats() {
        document.getElementById("filled-count").textContent = filledCities.size;
      }

      function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const minutes = Math.floor(elapsed / 60)
            .toString()
            .padStart(2, "0");
          const seconds = (elapsed % 60).toString().padStart(2, "0");
          document.getElementById(
            "timer"
          ).textContent = `${minutes}:${seconds}`;
        }, 1000);
      }

      function calculateNormalCDF(z) {
        const t = 1 / (1 + 0.2316419 * Math.abs(z));
        const d = 0.3989423 * Math.exp((-z * z) / 2);
        const p =
          d *
          t *
          (0.3193815 +
            t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
        return z >= 0 ? 1 - p : p;
      }

      // --- ä¿®æ”¹ï¼šç»“æŸæ¸¸æˆé€»è¾‘ ---
      function endGame() {
        if (isGameEnded) return;
        isGameEnded = true;
        clearInterval(timerInterval);

        renderProvinceList();

        const totalCities = 390;
        const accuracy = Math.round((filledCities.size / totalCities) * 100);
        const time = document.getElementById("timer").textContent;

        const score = filledCities.size;
        let expectedValue = 0;
        let variance = 0;

        accuracyData.forEach((item) => {
          const p = item.correct_percent / 100;
          expectedValue += p;
          variance += p * (1 - p);
        });

        const stdDev = Math.sqrt(variance);
        let zScore = 0;
        let percentile = 50;
        if (stdDev > 0) {
          zScore = (score - expectedValue) / stdDev;
          percentile = calculateNormalCDF(zScore) * 100;
        }

        showResult(accuracy, time, score, expectedValue, percentile);

        // æ–°å¢ï¼šåˆ‡æ¢æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€ï¼ˆéšè—æäº¤/ç»“æŸï¼Œæ˜¾ç¤ºæŸ¥çœ‹ç»“æœï¼‰
        document.getElementById("submit-btn").style.display = "none";
        document.getElementById("end-btn").style.display = "none";
        document.getElementById("show-result-btn").style.display =
          "inline-block";

        showMessage("ğŸ‰ æ¸¸æˆç»“æŸï¼æŸ¥çœ‹ç»“æœç»Ÿè®¡", "success");
      }

      function showResult(accuracy, time, score, expectedValue, percentile) {
        const resultStats = document.getElementById("result-stats");
        resultStats.innerHTML = `
                <div class="result-stat">
                    <span class="result-label">å®ŒæˆåŸå¸‚</span>
                    <span class="result-value">${filledCities.size}/390</span>
                </div>
                <div class="result-stat">
                    <span class="result-label">æ€»ç”¨æ—¶</span>
                    <span class="result-value">${time}</span>
                </div>
                <div class="result-stat">
                    <span class="result-label">å°è¯•æ¬¡æ•°</span>
                    <span class="result-value">${totalAttempts}</span>
                </div>
                <div class="result-stat">
                    <span class="result-label">æ­£ç¡®æ¬¡æ•°</span>
                    <span class="result-value">${correctAttempts}</span>
                </div>
                <div class="result-stat">
                    <span class="result-label">æ­£ç¡®ç‡</span>
                    <span class="result-value result-accuracy">${accuracy}%</span>
                </div>
            `;

        const finalStats = document.getElementById("final-stats");
        finalStats.innerHTML = `
                <div style="font-size: 1.4rem; margin-bottom:10px;">ä½ çš„å¾—åˆ†: <span class="highlight-val">${score}</span></div>
                <div class="stat-detail">å…¨ç½‘æŒ‘æˆ˜è€…å¹³å‡åˆ†: <span class="highlight-val">${expectedValue.toFixed(
                  2
                )}</span></div>
                <div class="stat-detail">ä½ çš„è¡¨ç°è¶…è¿‡äº†å…¨ç½‘ <span class="highlight-val">${percentile.toFixed(
                  1
                )}%</span> çš„ç”¨æˆ·</div>
            `;

        renderCityAccuracyList();
        document.getElementById("result-modal").style.display = "flex";
      }

      function renderCityAccuracyList() {
        const listContainer = document.getElementById("city-stats-list");
        listContainer.innerHTML =
          '<h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: #2c3e50;">å…¨ç½‘åŸå¸‚è¯†åˆ«çƒ­åº¦æ¦œï¼ˆç»¿è‰²ä¸ºæ‚¨ç­”å¯¹ï¼‰</h3>';

        const sortedAccuracy = [...accuracyData].sort(
          (a, b) => b.correct_percent - a.correct_percent
        );

        sortedAccuracy.forEach((item) => {
          let sysCityName = item.city_name;
          const fullSuffixes = ["ç‰¹åˆ«è¡Œæ”¿åŒº", "è‡ªæ²»å·", "åœ°åŒº", "ç›Ÿ", "æ—åŒº"];
          const isFullName = fullSuffixes.some((suffix) =>
            sysCityName.endsWith(suffix)
          );
          if (!isFullName && !sysCityName.includes("å¸‚")) {
            sysCityName += "å¸‚";
          }

          const isAnsweredCorrectly = filledCities.has(sysCityName);

          const row = document.createElement("div");
          row.className = "city-stat-row";

          const cityNameCol = document.createElement("div");
          cityNameCol.className = "city-name";
          cityNameCol.textContent = item.city_name;

          const barContainer = document.createElement("div");
          barContainer.className = "bar-container";

          const barFill = document.createElement("div");
          barFill.className = `bar-fill ${
            isAnsweredCorrectly ? "correct" : ""
          }`;
          barFill.style.width = `${item.correct_percent}%`;

          const percentCol = document.createElement("div");
          percentCol.className = "percent-text";
          percentCol.textContent = `${item.correct_percent}%`;

          barContainer.appendChild(barFill);
          row.appendChild(cityNameCol);
          row.appendChild(barContainer);
          row.appendChild(percentCol);
          listContainer.appendChild(row);
        });
      }

      function showMessage(text, type) {
        const messageEl = document.getElementById("message");
        messageEl.textContent = text;
        messageEl.className = `message ${type}`;
        setTimeout(() => {
          messageEl.className = "message";
        }, 3000);
      }

      function showTooltip(e, cityName) {
        tooltip.textContent = cityName;
        tooltip.style.left = `${e.clientX + 10}px`;
        tooltip.style.top = `${e.clientY + 10}px`;
        tooltip.style.opacity = 1;
      }

      function hideTooltip() {
        tooltip.style.opacity = 0;
      }

      // --- ä¿®æ”¹ï¼šé‡ç½®é€»è¾‘ ---
      function resetChallenge() {
        filledCities.clear();
        totalAttempts = 0;
        correctAttempts = 0;
        isGameEnded = false;

        isZoomed = false;
        scale = 1;
        translateX = 0;
        translateY = 0;

        clearInterval(timerInterval);
        startTimer();

        updateStats();
        renderProvinceList();

        const svgObj = document.getElementById("city-svg");
        if (svgObj.contentDocument) {
          const cityElements =
            svgObj.contentDocument.querySelectorAll("[data-name]");
          cityElements.forEach((elem) => {
            elem.style.fill = "";
          });

          const svgElement = svgObj.contentDocument.querySelector("svg");
          if (svgElement) {
            svgElement.style.transform = `translate(0px, 0px) scale(1)`;
            svgElement.style.transformOrigin = "0 0";
          }
        }

        // è¿˜åŸæŒ‰é’®çŠ¶æ€
        document.getElementById("submit-btn").style.display = "inline-block";
        document.getElementById("end-btn").style.display = "inline-block";
        document.getElementById("show-result-btn").style.display = "none";

        document.getElementById("city-input").focus();
        showMessage("ğŸ”„ å·²é‡ç½®æŒ‘æˆ˜ï¼Œé‡æ–°å¼€å§‹ï¼", "success");
      }

      document.addEventListener("DOMContentLoaded", () => {
        init();

        document.getElementById("submit-btn").addEventListener("click", () => {
          const input = document.getElementById("city-input").value.trim();
          if (input) {
            submitCity(input);
          } else {
            showMessage("è¯·è¾“å…¥åœ°çº§å¸‚åç§°ï¼", "error");
          }
        });

        document.getElementById("end-btn").addEventListener("click", () => {
          if (!isGameEnded) {
            endGame();
          }
        });

        // æ–°å¢ï¼šæŸ¥çœ‹ç»“æœæŒ‰é’®äº‹ä»¶
        document
          .getElementById("show-result-btn")
          .addEventListener("click", () => {
            document.getElementById("result-modal").style.display = "flex";
          });

        document
          .getElementById("city-input")
          .addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              const input = e.target.value.trim();
              if (input) {
                submitCity(input);
              }
            }
          });

        document
          .getElementById("reset-btn")
          .addEventListener("click", resetChallenge);

        document
          .getElementById("close-result-btn")
          .addEventListener("click", () => {
            document.getElementById("result-modal").style.display = "none";
          });

        document
          .getElementById("result-modal")
          .addEventListener("click", (e) => {
            if (e.target === document.getElementById("result-modal")) {
              document.getElementById("result-modal").style.display = "none";
            }
          });

        document.getElementById("city-input").focus();
      });
    </script>
  </body>
</html>
